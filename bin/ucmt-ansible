#! /usr/bin/ruby

require "yaml"

require "ucmt/ansible"
require 'optimist'
opts = Optimist::options do
  banner "Ansible backend to write salt configuration from UCMT configuration, run it or dry run it."
  opt :config, "Create salt configuration from ucmt configuration. Can be passed also as STDIN.", type: String
  opt :ansible_directory, "Where to write respective read states.yml", type: String, default: "~/"
  opt :dry_run, "Just prints state and what actions will be applied"
  opt :apply, "Apply configuration to system"
end
Optimist::die :apply, "Cannot have apply and dry_run together" if opts[:dry_run] && opts[:apply]

if opts[:config]
  data = YAML.load_file(opts[:config])
else
  stdin = STDIN.tty? ? nil : STDIN.read
  data = YAML.load(stdin) if stdin && !stdin.empty?
end

ansible = UCMT::Ansible.new(File.expand_path(opts[:ansible_directory]))
nocmd = true
if data
  ansible.write(data)
  nocmd = false
end
if opts[:dry_run]
  ansible.dry_run
  nocmd = false
end
if opts[:apply]
  ansible.apply
  nocmd = false
end

Optimist::die "At least one of UCMT configuration/apply/dry-run has to be specified." if nocmd
