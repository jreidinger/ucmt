#! /usr/bin/ruby

require "yaml"

require "ucmt/ansible"
require 'optimist'
opts = Optimist::options do
  opt :config, "Create salt configuration from ucmt configuration. Can be passed also as STDIN.", type: String
  opt :ansible_directory, "Where to write respective read states.yml", type: String, default: "~/"
  opt :dry_run, "Just prints state and what actions will be applied"
  opt :apply, "Apply configuration to system"
end
Optimist::die :apply, "Cannot have apply and dry_run together" if opts[:dry_run] && opts[:apply]

if opts[:config]
  data = YAML.load_file(opts[:config])
else
  stdin = STDIN.tty? ? nil : STDIN.read
  data = YAML.load(stdin) if stdin && !stdin.empty?
end

ansible = UCMT::Ansible.new(File.expand_path(opts[:ansible_directory]))
if data
  ansible.write(data)
end
if opts[:dry_run]
  ansible.dry_run
end
if opts[:apply]
  ansible.apply
end

