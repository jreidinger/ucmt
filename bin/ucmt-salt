#! /usr/bin/ruby

require "yaml"

require "ucmt/salt"
require 'optimist'

opts = Optimist::options do
  banner "Salt backend to write salt configuration from UCMT configuration, run it or dry run it."
  opt :config, "Create salt configuration from ucmt configuration. Can be passed also as STDIN.", type: String
  opt :salt_directory, "Where to write respective read salt configuration", type: String, default: "/srv/salt"
  opt :dry_run, "Just prints state and what actions will be applied"
  opt :apply, "Apply configuration to system"
end
Optimist::die :apply, "Cannot have apply and dry_run together" if opts[:dry_run] && opts[:apply]

if opts[:config]
  data = YAML.load_file(opts[:config])
else
  stdin = STDIN.tty? ? nil : STDIN.read
  data = YAML.load(stdin) if stdin && !stdin.empty?
end

salt = UCMT::Salt.new(opts[:salt_directory])
nocmd = true
if data
  salt.write(data)
  nocmd = false
end
if opts[:dry_run]
  salt.dry_run
  nocmd = false
end
if opts[:apply]
  salt.apply
  nocmd = false
end

Optimist::die "At least one of UCMT configuration/apply/dry-run has to be specified." if nocmd
